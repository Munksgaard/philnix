name: Test NixOS Configurations

on:
  push:
    branches: [ main, claude/* ]
  pull_request:
    branches: [ main ]

jobs:
  test-builds:
    name: Build NixOS Configurations
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Only test hoare for now - church will be re-enabled after refactoring
        config: [hoare]
    steps:
      # Free up disk space - NixOS builds need lots of space
      # https://github.com/easimon/maximize-build-space
      - name: Free disk space
        uses: easimon/maximize-build-space@v10
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          install_url: https://releases.nixos.org/nix/nix-2.31.1/install
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build ${{ matrix.config }} configuration
        run: |
          nix build .#nixosConfigurations.${{ matrix.config }}.config.system.build.toplevel \
            --show-trace \
            --print-build-logs

      - name: Report build size
        run: |
          SIZE=$(du -sh result | cut -f1)
          echo "âœ… ${{ matrix.config }} configuration built successfully (size: $SIZE)"

  test-checks:
    name: Run NixOS Tests
    runs-on: ubuntu-latest
    needs: test-builds
    strategy:
      matrix:
        # Only test hoare for now - church checks will be re-enabled after refactoring
        check: [hoare-build, hoare-test]
    steps:
      # Free up disk space - NixOS builds need lots of space
      - name: Free disk space
        uses: easimon/maximize-build-space@v10
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          install_url: https://releases.nixos.org/nix/nix-2.31.1/install
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Run ${{ matrix.check }}
        run: |
          nix build .#checks.x86_64-linux.${{ matrix.check }} \
            --show-trace \
            --print-build-logs

      - name: Report success
        run: echo "âœ… ${{ matrix.check }} passed successfully!"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-builds, test-checks]
    steps:
      - name: Report overall success
        run: |
          echo "ðŸŽ‰ All NixOS configurations built and tested successfully!"
          echo "âœ… hoare configuration: PASSED"
          echo "Note: church tests temporarily disabled until refactoring updates the config"
